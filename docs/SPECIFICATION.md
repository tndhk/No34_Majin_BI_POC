# Data BI Analytics App 仕様書

## 1. 概要

### 1.1 プロダクトビジョン

CSVをアップロードするだけで、AIが自動的にデータを分析し、インタラクティブなダッシュボードを生成。
その後、AIアシスタントと対話しながら、さらなる深掘り分析を行える次世代BIツール。

### 1.2 コンセプト

```
「ワンショット生成 + 対話型深掘り」
```

### 1.3 ターゲットユーザー

- データ分析の専門知識がないビジネスユーザー
- 素早くデータからインサイトを得たいマネージャー
- レポート作成を効率化したいアナリスト

---

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 ワンショットダッシュボード生成

| 項目         | 内容                                              |
| ------------ | ------------------------------------------------- |
| 概要         | CSVアップロード後、ボタン一つでダッシュボード生成 |
| 入力         | CSVファイル（日本語対応、Shift_JIS/UTF-8）        |
| 出力         | 20+グラフを含むインタラクティブダッシュボード     |
| 処理時間目標 | 30秒〜1分以内                                     |

**フロー:**

```
[CSV Upload] → [自動分析] → [ダッシュボード表示]
     ↓              ↓              ↓
   ユーザー      バックグラウンド    完了通知
   アクション    （進捗表示）      + チャット開始
```

#### 2.1.2 AIチャットによる対話型分析

| 項目         | 内容                                     |
| ------------ | ---------------------------------------- |
| 概要         | 生成されたダッシュボードについてAIと対話 |
| 機能         | 質問応答、追加グラフ生成、深掘り分析     |
| コンテキスト | アップロードデータ + 生成ダッシュボード  |

**対話例:**

```
User: 「東京と大阪の売上を比較したい」
AI:   → 比較グラフを生成・追加

User: 「なぜ3月に売上が落ちたの？」
AI:   → データを分析し、考察を提示

User: 「商品カテゴリ別のトレンドを見せて」
AI:   → 新規グラフを生成・追加

User: 「この分析結果をまとめて」
AI:   → サマリーレポートを生成
```

### 2.2 対話型分析の機能詳細

#### 2.2.1 質問応答

- データに関する質問に回答
- 数値の根拠をデータから提示
- トレンドや傾向の説明

#### 2.2.2 追加グラフ生成

- ユーザーのリクエストに基づき新規グラフ作成
- 既存ダッシュボードに動的追加
- グラフ種類の変更・カスタマイズ

#### 2.2.3 深掘り分析

- 相関分析（2変数間の関係）
- 比較分析（セグメント間の比較）
- 時系列分析（トレンド、季節性）
- 異常値検出（外れ値の特定と説明）

#### 2.2.4 インサイト生成

- データの特徴を自動解説
- ビジネス上の示唆を提示
- アクションの提案

### 2.3 ダッシュボード機能（継承）

現行機能を継承：

- 20+グラフの自動生成
- KPIパネル表示
- フィルター機能（エリア、期間等）
- グラフカスタマイズ（種類変更、色変更）
- PDF出力
- JSON出力
- レイアウト切替（1列/2列）
- 個別グラフ画像保存

---

## 3. 画面設計

### 3.1 メイン画面レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│  📊 Data BI Analytics                          [Settings]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  CSVファイルをドロップ または クリックして選択      │   │
│  │              📁 sample_data.csv                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [🚀 ダッシュボードを生成]                                 │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────┬───────────────────────┐   │
│  │                             │                       │   │
│  │      ダッシュボード          │   💬 AI アシスタント  │   │
│  │      エリア                  │                       │   │
│  │                             │   このデータの特徴:    │   │
│  │   [KPIパネル]               │   • 売上は右肩上がり  │   │
│  │   [グラフ1] [グラフ2]       │   • 東京が最大シェア  │   │
│  │   [グラフ3] [グラフ4]       │                       │   │
│  │      ...                    │   何を深掘りしますか？ │   │
│  │                             │                       │   │
│  │                             │   ────────────────    │   │
│  │                             │   [メッセージ入力...]  │   │
│  │                             │                       │   │
│  └─────────────────────────────┴───────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 画面状態遷移

```
[初期状態]
    │
    ↓ CSVアップロード
[アップロード完了]
    │
    ↓ 「ダッシュボード生成」クリック
[生成中] ─────────────────────────┐
    │                             │
    │  ┌─────────────────────┐   │
    │  │ 分析中... 20%       │   │
    │  │ ━━━━━━░░░░░░░░░░░░ │   │
    │  │                     │   │
    │  │ ✓ データ読み込み    │   │
    │  │ → 構造分析中...     │   │
    │  │ ○ グラフ生成        │   │
    │  │ ○ ダッシュボード構築 │   │
    │  └─────────────────────┘   │
    │                             │
    ↓                             │
[ダッシュボード表示]←─────────────┘
    │
    ↓ チャット入力
[対話型分析モード]
    │
    ├─→ 追加グラフ生成
    ├─→ 質問応答
    ├─→ 深掘り分析
    └─→ レポート生成
```

### 3.3 チャットUI仕様

#### メッセージタイプ

| タイプ    | 表示           | 内容                           |
| --------- | -------------- | ------------------------------ |
| system    | 灰色背景       | 初期メッセージ、データサマリー |
| user      | 右寄せ、青背景 | ユーザーの質問・リクエスト     |
| assistant | 左寄せ、白背景 | AIの回答                       |
| chart     | カード形式     | 生成されたグラフ               |
| insight   | アイコン付き   | 分析インサイト                 |

#### 入力補助

- サジェスト機能（よくある質問を提示）
- 音声入力（将来対応）
- ファイル添付（追加CSV、将来対応）

---

## 4. 技術仕様

### 4.1 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      Frontend (Streamlit)                   │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ File Upload │  │ Dashboard   │  │ Chat Interface      │ │
│  │ Component   │  │ Viewer      │  │ (st.chat_message)   │ │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘ │
│         │                │                     │            │
├─────────┼────────────────┼─────────────────────┼────────────┤
│         ↓                ↓                     ↓            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Session State Manager                   │   │
│  │  • csv_data    • dashboard_html    • chat_history   │   │
│  │  • df_full     • aggregated_data   • context        │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
├───────────────────────────┼─────────────────────────────────┤
│                           ↓                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Analysis Engine                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │
│  │  │ Data        │  │ Dashboard   │  │ Chat        │ │   │
│  │  │ Processor   │  │ Generator   │  │ Handler     │ │   │
│  │  │ (Pandas)    │  │ (AI+HTML)   │  │ (AI)        │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
├───────────────────────────┼─────────────────────────────────┤
│                           ↓                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Gemini API                              │   │
│  │  • Blueprint生成  • コード生成  • 対話応答          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 データフロー

#### ワンショット生成フロー

```
1. CSV Upload
   ↓
2. Data Loading (Pandas)
   - エンコーディング自動判定
   - 基本統計量計算
   ↓
3. AI Blueprint生成 (Phase 1)
   - カラム分析
   - グラフ提案（20+）
   ↓
4. AI Code生成 (Phase 2)
   - Python集計コード
   - HTMLダッシュボード
   ↓
5. Python実行
   - aggregate_all_data(df)
   - JSON生成
   ↓
6. HTML組み立て
   - JSON注入
   - Direct View Shim追加
   ↓
7. Dashboard表示 + Chat初期化
```

#### 対話型分析フロー

```
1. User Input (質問/リクエスト)
   ↓
2. Context構築
   - 元データのサマリー
   - 現在のダッシュボード状態
   - 会話履歴
   ↓
3. AI処理
   - 意図分類
   - 適切な処理選択
   ↓
4. 処理実行
   ├─ 質問応答 → テキスト回答
   ├─ グラフ追加 → 新規グラフ生成
   ├─ 分析 → 計算 + 説明
   └─ レポート → サマリー生成
   ↓
5. 結果表示
   - チャットに回答追加
   - 必要に応じてダッシュボード更新
```

### 4.3 セッション状態

```python
st.session_state = {
    # データ関連
    "csv_data": str,              # 生CSVテキスト
    "df_full": pd.DataFrame,      # 全データ
    "df_summary": dict,           # データサマリー

    # ダッシュボード関連
    "blueprint": str,             # AI生成のBlueprint
    "aggregated_data": dict,      # 集計済みデータ
    "dashboard_html": str,        # 生成HTML
    "additional_charts": list,    # 追加グラフリスト

    # チャット関連
    "chat_history": list,         # 会話履歴
    "chat_context": dict,         # AIコンテキスト

    # 状態管理
    "generation_status": str,     # "idle" | "generating" | "complete"
    "current_step": int,          # 生成ステップ
}
```

### 4.4 API設計

#### チャットハンドラー

```python
def handle_chat_message(user_message: str) -> ChatResponse:
    """
    ユーザーメッセージを処理し、適切な応答を生成

    Returns:
        ChatResponse: {
            "type": "text" | "chart" | "insight" | "error",
            "content": str | dict,
            "chart_html": str | None,  # グラフ生成時
            "data_update": dict | None  # データ更新時
        }
    """
```

#### 追加グラフ生成

```python
def generate_additional_chart(request: str, context: dict) -> ChartResult:
    """
    ユーザーリクエストに基づいて追加グラフを生成

    Returns:
        ChartResult: {
            "chart_id": str,
            "title": str,
            "html": str,
            "data": dict
        }
    """
```

---

## 5. 非機能要件

### 5.1 パフォーマンス

| 項目                   | 目標値              |
| ---------------------- | ------------------- |
| ダッシュボード生成時間 | 60秒以内            |
| チャット応答時間       | 5秒以内             |
| 追加グラフ生成時間     | 10秒以内            |
| 対応データサイズ       | 100MB / 100万行まで |

### 5.2 ユーザビリティ

- 直感的なUI（説明不要で使える）
- 進捗表示（待ち時間のストレス軽減）
- エラーメッセージの分かりやすさ
- レスポンシブデザイン

### 5.3 信頼性

- エラー時のグレースフルデグラデーション
- セッション状態の保持
- API障害時のリトライ機構

### 5.4 セキュリティ

- APIキーの安全な管理
- アップロードファイルの検証
- XSS対策（生成HTML）

---

## 6. 将来拡張

### Phase 2（将来）

- 複数データソース対応（Excel、DB接続）
- ダッシュボード保存・共有機能
- テンプレート機能
- スケジュール実行

### Phase 3（将来）

- マルチユーザー対応
- 権限管理
- 監査ログ
- API提供

---

## 7. 用語定義

| 用語             | 定義                                       |
| ---------------- | ------------------------------------------ |
| ワンショット生成 | CSV投入から最終ダッシュボードまで一括実行  |
| Blueprint        | AIが提案するグラフ構成案                   |
| 対話型分析       | チャットUIを通じたインタラクティブな分析   |
| 深掘り           | 既存分析を起点にさらに詳細な分析を行うこと |
| コンテキスト     | AIが回答生成時に参照するデータと会話履歴   |
